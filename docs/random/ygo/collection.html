<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YuGiOh Collections</title>
  <style>
    :root{
      --img-w:480px; --img-h:700px; --accent:#c62828; --text:#eee;
    }
    html,body{height:100%;margin:0;background:#070707;color:var(--text);font-family:Inter,Segoe UI,system-ui,Arial}
    header{padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:12px}
    header h1{margin:0;color:var(--accent);font-size:20px}
    main{padding:22px;max-width:1200px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
    .collection{background:#111;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);transition:transform .18s}
    .collection:hover{transform:translateY(-6px)}
    .cover{width:100%;height:0;padding-bottom:145%;position:relative;background:#222}
    .cover img{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:var(--img-w);height:var(--img-h);object-fit:cover;max-width:100%;max-height:100%}
    .meta{padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
    .name{font-weight:700;color:#fff}
    .counts{font-size:13px;color:#ddd}
    .open-btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}
    footer{padding:18px;text-align:center;color:#888}
  </style>
</head>
<body>
  <header>
    <h1>YuGiOh Collections</h1>
    <div style="color:#bbb">Click a cover to open the collection</div>
  </header>

  <main>
  <div style="margin-bottom:18px">
    <button id="copyAllMissingBtn" style="
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 14px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;">
      Copy aaaallll Missing Items
    </button>
  </div>
  <div id="collectionsGrid" class="grid" aria-live="polite"></div>
</main>

<script>
  const COLLECTIONS_JSON = 'collections.json';
  const CARDS_CSV = 'cards.csv';
  const MISSING_IMG = 'missing.png';

  async function loadCsv(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to load ' + url);
      const text = await res.text();
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
      let start = 0;
      if (lines.length && /name/i.test(lines[0]) && /photo/i.test(lines[0])) start = 1;
      const map = new Map();
      for (let i = start; i < lines.length; i++) {
          const parts = lines[i].split('|');
          const name = (parts[0] || '').trim();
          if (!name) continue;
          const photoUrl = (parts[13] || '').trim() || null;
          const key = name.toLowerCase();
          if (!map.has(key)) map.set(key, { name, photoUrl });
      }
      return map;
  }

  async function loadJson(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error('Failed to load ' + url);
      return r.json();
  }

  function createCollectionCard(col, cardMap) {
      const total = (col.children || []).length;
      const have = (col.children || []).filter(n => cardMap.has(n.trim().toLowerCase())).length;
      const coverName = (col.coverCard || '').trim();
      const coverEntry = cardMap.get(coverName.toLowerCase());
      const coverUrl = coverEntry && coverEntry.photoUrl ? coverEntry.photoUrl : MISSING_IMG;

      const wrapper = document.createElement('div');
      wrapper.className = 'collection';

      const cover = document.createElement('div');
      cover.className = 'cover';
      const img = document.createElement('img');
      img.alt = col.name + ' cover';
      img.src = coverUrl;
      img.style.cursor = 'pointer';
      img.addEventListener('click', () => {
          const q = new URLSearchParams({ collection: col.name }).toString();
          window.location.href = 'collection_single.html?' + q;
      });
      cover.appendChild(img);

      const meta = document.createElement('div');
      meta.className = 'meta';
      const left = document.createElement('div');
      left.innerHTML = `<div class="name">${col.name}</div><div class="counts">${have}/${total} cards</div>`;
      const right = document.createElement('div');
      const btn = document.createElement('a');
      btn.className = 'open-btn';
      btn.textContent = 'Open';
      btn.href = 'collection_single.html?' + new URLSearchParams({ collection: col.name }).toString();
      right.appendChild(btn);

      meta.appendChild(left);
      meta.appendChild(right);
      wrapper.appendChild(cover);
      wrapper.appendChild(meta);
      return wrapper;
  }

  async function init() {
      try {
          const [cardMap, collections] = await Promise.all([loadCsv(CARDS_CSV), loadJson(COLLECTIONS_JSON)]);
          const grid = document.getElementById('collectionsGrid');
          grid.innerHTML = '';

          collections.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));

          for (const col of collections) {
              const card = createCollectionCard(col, cardMap);
              grid.appendChild(card);
          }

          // Wire up the "Copy aaaallll Missing Items" button
          const copyBtn = document.getElementById('copyAllMissingBtn');
          copyBtn.onclick = async () => {
              try {
                  const missingItems = [];
                  for (const col of collections) {
                      const children = col.children || [];
                      for (const name of children) {
                          const key = name.trim().toLowerCase();
                          if (!cardMap.has(key)) {
                              missingItems.push(name.trim());
                          }
                      }
                  }
                  if (missingItems.length === 0) {
                      alert("No missing items found!");
                      return;
                  }
                  await navigator.clipboard.writeText(missingItems.join('\n'));
                  copyBtn.textContent = "Copied!";
                  setTimeout(() => copyBtn.textContent = "Copy aaaallll Missing Items", 1500);
              } catch (err) {
                  alert("Failed to copy: " + err);
              }
          };

      } catch (err) {
          console.error(err);
          document.getElementById('collectionsGrid').innerHTML =
            '<div style="padding:20px;color:#f66">Error loading data. Check console.</div>';
      }
  }

  init();
</script>

</body>
</html>
